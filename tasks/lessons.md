# Lessons

## 2026-02-27

### 用户纠偏：不要停在“发现上层仓库脏改动”这一步
- 触发场景：目录位于上层大型 Git 仓库内，`git status` 输出大量无关文件。
- 本次修正规则：
  - 先在目标项目目录初始化独立 `.git` 仓库，再继续提交/推送。
  - 仅在确实会影响目标目录改动时再向用户中断确认。
  - 需要发布代码时，优先保证“目标项目可独立版本化”再做其余收尾工作。

### 用户纠偏：公式复制不能带异常换行，且要参考现有成熟实现
- 触发场景：直接读取 KaTeX annotation 文本时，复制结果出现多余换行，影响 LaTeX 可用性。
- 本次修正规则：
  - 公式复制必须先做 LaTeX 源码归一化（去除硬换行、合并多余空白）。
  - 遇到已有参考项目时，先迁移其能力模型（识别/格式/复制回退/提示），再做页面适配。
  - 复杂交互优先模块化（独立服务文件），主内容脚本仅做装配与配置同步。

### 用户纠偏：按阶段推进迁移，先完成 timeline 再扩展其它能力
- 触发场景：需求包含多个迁移项时，用户明确要求先做 timeline。
- 本次修正规则：
  - 接到阶段化指令后，先聚焦当前阶段（timeline）并闭环验证，再进入下一批功能。
  - 每一阶段都要输出可运行产物（代码+打包）并同步文档状态。
  - 避免在同一迭代混入过多并行功能，保持改动职责边界清晰。

### 用户纠偏：用户限定“只迁移这几个”时，严格控制本轮范围
- 触发场景：用户点名只迁移 `sidebarAutoHide` / `folderSpacing` / `markdownPatcher` / `snowEffect`。
- 本次修正规则：
  - 本轮实现仅覆盖用户点名模块，不夹带其它迁移项。
  - 若需要公共装配改动（storage/面板），只做与这几项直接相关的最小改动。
  - 回报结果时明确“已完成模块”和“未触碰模块”，避免范围歧义。

### 用户纠偏：迁移功能后还要统一 UI，并把导出能力作为主路径
- 触发场景：功能已迁移但面板信息密度高、导出与增强配置混在一起，用户要求与 Gemini 插件保持统一体验。
- 本次修正规则：
  - 功能迁移完成后，必须补做信息架构收敛（导出主路径与配置分区分离）。
  - 视觉迁移不只改颜色，需同步改布局层次（tab/分组）和状态持久化。
  - 新增功能进入面板时，优先放入“工作区”分区，避免挤占导出首屏路径。

### 用户纠偏：设置入口应放在扩展图标 popup，页面内不保留悬浮标
- 触发场景：页面悬浮按钮占位且干扰阅读，用户要求将配置入口迁移到浏览器顶部扩展图标。
- 本次修正规则：
  - 设置类入口默认优先放 `action popup`，页面内仅保留必要的内容辅助 UI。
  - 对于已迁移到 popup 的设置，content script 必须支持消息补丁并实时生效，避免“改了要刷新”。
  - 时间轴等高频交互功能要优先优化响应路径（滚动节流、二分命中、搜索防抖、滚轮隔离），再做视觉调整。

### 用户纠偏：时间线要“可拖、可跳、可快速加载”，导出设置需贴近时间线
- 触发场景：时间线交互滞后（加载慢、圆点跳转失效、拖拽区域太窄）且导出设置入口位置不符合操作路径。
- 本次修正规则：
  - 时间线默认位置放右侧；除圆点附近外，整条轨道都应可拖拽并反馈手型光标。
  - 时间线刷新必须走轻量数据通路（快速 turns 采集 + 独立刷新节奏），不能依赖导出全量解析完成。
  - 导出参数若主要服务时间线跳转上下文，应优先放在时间线附近（预览面板下方）；popup 保持全局设置收敛。

### 用户纠偏：公式交互要“背景即按钮”，独立公式不应高亮整行空白
- 触发场景：公式悬停时复制按钮干扰阅读，且块级公式背景覆盖了左右留白、上下边缘包裹不完整。
- 本次修正规则：
  - 公式复制默认走“点击公式节点即复制”，不额外显示按钮。
  - 块级公式只给公式本体节点加高亮，不给整行容器加背景。
  - 高亮样式必须通过 padding + 负 margin 修正行高边缘，避免上下露边。

### 用户纠偏：发布前需要统一产品命名并完善 README
- 触发场景：用户要求同步 GitHub 时同时更换产品名，并将 README 升级为正式项目文档。
- 本次修正规则：
  - 发布前先做命名一致性检查（manifest/popup/面板文案/日志前缀/打包产物名）。
  - README 不能只做增量补丁，应按“定位-能力-使用-构建-结构”整体重写。
  - 推送前需完成一次完整校验（语法 + 打包）再提交远端。
